/*
* ABSENSI - GOOGLE SCRIPT (Versi Visual & Validasi Jarak Rapi)
* ***********************************************************************************
* Code by : fahroni|ganteng (modifikasi visual)
* License : MIT
*/

// -------------------- SET VARIABLE --------------------
var idGambarLogo = '1ssHyzoR5W-7xEH1DSni9sNjfUeDL0Hew';
var idDataPegawai = '1a9skIyyXSYqNwaQcs5p-6RPqUwoSE7DCxtRd801yI38';
var idFolderAbsensi = '1qvPqxM6IpJTm2o6ycSDs95jv4q-BJPT_';
var namaPerusahaan = 'PASCASARJANA';
var lokasiPerusahaan = [-7.863452547618916, 111.492059379797];
var jarakMaxWFO = 0.15;
var jarakMaxWFH = 3000;
var jamMasuk = '15:00:00';
var jamPulang = '21:30:00';
var tidakAbsen = 4; 
var timeZone = 'GMT+07:00';
var timeZoneCity = 'Asia/Jakarta';
var localeCode = 'id';

//====================================================================================
const TOKEN = "SECRET_TOKEN_123456";

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    if (data.token !== TOKEN) {
      return output(false, "Token tidak valid");
    }

    const sheet = SpreadsheetApp.openById("SPREADSHEET_ID_ANDA")
                  .getSheetByName("Sheet1");

    sheet.appendRow([
      new Date(),
      data.idPegawai,
      data.absensi,
      data.workFrom,
      data.kegiatan,
      data.latitude,
      data.longitude
    ]);

    return output(true, "Data berhasil disimpan");
  } catch(err) {
    return output(false, "Error: " + err.message);
  }
}

function output(success, msg){
  return ContentService
    .createTextOutput(JSON.stringify({success:success, msg:msg}))
    .setMimeType(ContentService.MimeType.JSON);
}


//======================================================================================
// -------------------- CLASS ABSENSI --------------------
class absensi {
  constructor(dt) {
    this.dt = dt;
    this.dt.idPegawai = this.dt['idPegawai'] ? this.dt.idPegawai.toString() : '';
    this.dt.password = this.dt['password'] ? this.dt.password.toString() : '';
    this.dt.kegiatan = this.dt['kegiatan'] ? this.dt.kegiatan.toString() : '';
    this.dt.absensi = this.dt['absensi'] ? this.dt.absensi.toString() : '';
    this.dt.workFrom = this.dt['workFrom'] ? this.dt.workFrom.toString() : '';
    this.dt.position = this.dt['position'] || [0,0];

    this.indexUser = -1;
    let user = SpreadsheetApp.openById(idDataPegawai);
    let userSheet = user.getSheetByName('Pegawai');
    this.user = userSheet.getRange(2, 1, userSheet.getRange("A1").getDataRegion().getLastRow() - 1, 10).getValues();
  }

  getSpreatsheetDataAbsensi(now){
    let spreadsheetName = Utilities.formatDate(now, timeZone, "yyyy-MM");
    let sheetName = 'Absensi Pegawai';
    let dir = DriveApp.getFolderById(idFolderAbsensi);
    let fileName = dir.getFilesByName(spreadsheetName);
    let dataAbsensi, shDataAbsensi;

    if(!fileName.hasNext()){
      dataAbsensi = SpreadsheetApp.create(spreadsheetName);
      dataAbsensi.setSpreadsheetTimeZone(timeZoneCity);
      dataAbsensi.setSpreadsheetLocale(localeCode);
      dataAbsensi.renameActiveSheet(sheetName);
      DriveApp.getFileById(dataAbsensi.getId()).moveTo(dir);
      shDataAbsensi = dataAbsensi.getSheetByName(sheetName);
      shDataAbsensi.getRange('A1:O1')
        .setValues([['TGL','ID','NAMA','BAGIAN','JAM MASUK','POTONGAN MASUK','STATUS MASUK','JARAK MASUK','LOKASI MASUK','JAM PULANG','POTONGAN PULANG','STATUS PULANG','JARAK PULANG','LOKASI PULANG','KEGIATAN']])
        .setHorizontalAlignment('center').setVerticalAlignment('middle').setWrap(true)
        .setBackground('#000000').setFontColor('#FFFFFF').setFontFamily('Comfortaa');
      shDataAbsensi.getRange('E1:I1').setBackground('#274E13');
      shDataAbsensi.getRange('J1:N1').setBackground('#660000');
      shDataAbsensi.setColumnWidth(9,150);
      shDataAbsensi.setColumnWidth(14,150);
      shDataAbsensi.setColumnWidth(15,300);
    } else { 
      dataAbsensi = SpreadsheetApp.open(fileName.next());
      shDataAbsensi = dataAbsensi.getSheetByName(sheetName);
    }
    return shDataAbsensi;
  }

  getUserAbsen(shDataAbsensi,dateNow){
    let user = this.user[this.indexUser];
    let jmlDataAbsensi = shDataAbsensi.getRange("A1").getDataRegion().getLastRow() - 1;
    let indexAbsensi = -1;
    if(jmlDataAbsensi>0){
      let dataAbsensi = shDataAbsensi.getRange(2, 1, jmlDataAbsensi, 2).getValues();
      for (let i=0; i<dataAbsensi.length;i++) {
        let dateDataAbsensi = Utilities.formatDate(dataAbsensi[i][0], timeZone, 'yyyy-MM-dd');
        if(dataAbsensi[i][1]+dateDataAbsensi == user[1]+dateNow) {
          indexAbsensi = i;
          break;
        }
      }
    }
    return indexAbsensi;
  }

  potonganMasuk(now){
    let dateNow = Utilities.formatDate(now, timeZone, 'yyyy-MM-dd');
    let jamMasukToday = new Date(dateNow+'T'+jamMasuk);
    let telat = Math.ceil(Math.max(0, now.getTime()-jamMasukToday.getTime())/(1000*60*60));
    return Math.min(telat, tidakAbsen);
  }

  potonganPulang(now){
    let dateNow = Utilities.formatDate(now, timeZone, 'yyyy-MM-dd');
    let jamPulangToday = new Date(dateNow+'T'+jamPulang);
    let pulangAwal = Math.ceil(Math.max(0, jamPulangToday.getTime()-now.getTime())/(1000*60*60));
    return Math.min(pulangAwal, tidakAbsen);
  }

  saveAbsensi() {
    let now = new Date();
    let dateNow = Utilities.formatDate(now, timeZone, 'yyyy-MM-dd');
    let timeNow = Utilities.formatDate(now, timeZone, 'yyyy-MM-dd HH:mm:ss');
    let shDataAbsensi = this.getSpreatsheetDataAbsensi(now);

    if(this.indexUser<0) return {success:false,msg:'User tidak ditemukan.'};

    let user = this.user[this.indexUser];
    let indexAbsensi = this.getUserAbsen(shDataAbsensi,dateNow);
    let ret={success:false,msg:''};
    let masuk = this.dt.absensi=='Masuk';
    let koordinat = (this.dt.position && this.dt.position.length==2) ? this.dt.position[0]+','+this.dt.position[1] : '';
    if(typeof this.distance!=='number') this.distance=0;
    let potMasuk=this.potonganMasuk(now);
    let potPulang=this.potonganPulang(now);

    // Highlight warna: merah jika telat/pulang cepat
    function highlightCell(range, potongan){
      if(potongan>0) range.setBackground('#ff9999');
      else range.setBackground('#b3ffb3'); // hijau jika tepat waktu
    }

    if(indexAbsensi<0){
      shDataAbsensi.appendRow([
        dateNow, user[1]||'', user[2]||'', user[3]||'',
        masuk?timeNow:'', masuk?potMasuk:tidakAbsen, masuk?this.dt.workFrom||'':'', masuk?this.distance:'', masuk?koordinat:'',
        !masuk?timeNow:'', !masuk?potPulang:tidakAbsen, !masuk?this.dt.workFrom||'':'', !masuk?this.distance:'', !masuk?koordinat:'', this.dt.kegiatan||''
      ]);
      let lastRow = shDataAbsensi.getLastRow();
      highlightCell(shDataAbsensi.getRange(lastRow,5), potMasuk);
      highlightCell(shDataAbsensi.getRange(lastRow,10), potPulang);
      ret.success=true;
      ret.msg=user[2]||'';
    } else {
      indexAbsensi+=2;
      indexAbsensi=Math.max(indexAbsensi,2);
      let absenMasukVal=shDataAbsensi.getRange(indexAbsensi,5).getValue();
      let absenPulangVal=shDataAbsensi.getRange(indexAbsensi,10).getValue();

      if(masuk){
        if(absenMasukVal){
          ret.msg='Anda sudah melakukan absensi masuk jam '+Utilities.formatDate(absenMasukVal,timeZone,'HH:mm:ss');
        } else {
          shDataAbsensi.getRange(indexAbsensi,5,1,5).setValues([[timeNow,potMasuk,this.dt.workFrom||'',this.distance,koordinat]]);
          highlightCell(shDataAbsensi.getRange(indexAbsensi,5),potMasuk);
          ret.success=true;
          ret.msg=user[2]||'';
        }
      } else {
        if(absenPulangVal){
          ret.msg='Anda sudah melakukan absensi pulang jam '+Utilities.formatDate(absenPulangVal,timeZone,'HH:mm:ss');
        } else {
          shDataAbsensi.getRange(indexAbsensi,10,1,6).setValues([[timeNow,potPulang,this.dt.workFrom||'',this.distance,koordinat,this.dt.kegiatan||'']]);
          highlightCell(shDataAbsensi.getRange(indexAbsensi,10),potPulang);
          ret.success=true;
          ret.msg=user[2]||'';
        }
      }
    }

    shDataAbsensi.getRange('E:E').setNumberFormat('H:mm:ss');
    shDataAbsensi.getRange('J:J').setNumberFormat('H:mm:ss');

    return ret;
  }

  validUser(){
    let id=this.user.map(r=>r[1].toString().toUpperCase());
    let pass=this.user.map(r=>r[4].toString());
    this.indexUser=id.indexOf(this.dt.idPegawai.toUpperCase());
    return (this.indexUser>=0 && pass[this.indexUser]==this.dt.password);
  }

  validDistance(){
    let bolehAbsenDariRumah=['WFH','Ijin'];
    if(this.dt.position[0]==0 && this.dt.position[1]==0) return 'Lokasi anda tidak terekam...';
    this.distance=this.getDistanceBetween(lokasiPerusahaan[0],lokasiPerusahaan[1],this.dt.position[0],this.dt.position[1]);
    let mapsLink = 'https://www.google.com/maps/dir/?api=1&origin='+this.dt.position[0]+','+this.dt.position[1]+'&destination='+lokasiPerusahaan[0]+','+lokasiPerusahaan[1]+'&travelmode=walking';
    if(this.distance>jarakMaxWFO && !bolehAbsenDariRumah.includes(this.dt.workFrom))
      return 'Lokasi terlalu jauh dari kampus: <a href="'+mapsLink+'" target="_blank">'+this.distance.toFixed(2)+' km</a><br>Maks jarak WFO: 80m';
    if(this.distance>jarakMaxWFH && bolehAbsenDariRumah.includes(this.dt.workFrom))
      return 'Lokasi terlalu jauh dari kampus: <a href="'+mapsLink+'" target="_blank">'+this.distance.toFixed(2)+' km</a><br>Maks jarak WFH: '+jarakMaxWFH+' km';
    return 'confirm';
  }

  getDistanceBetween(originLat,originLong,destLat,destLong){
    let directions=Maps.newDirectionFinder().setOrigin(originLat,originLong).setDestination(destLat,destLong).setMode(Maps.DirectionFinder.Mode.WALKING).getDirections();
    if(directions.routes[0]){
      return directions.routes[0].legs.reduce((acc,row)=>{acc.dist+=row.distance.value/1000;acc.dur+=row.duration.value/60;return acc;},{dist:0,dur:0}).dist;
    } else return 0;
  }
}

// -------------------- GLOBAL FUNCTIONS --------------------
function doGet(e){ return ContentService.createTextOutput("Backend Absensi Aktif").setMimeType(ContentService.MimeType.TEXT); }

function doPost(e){
  let dt;
  try{ dt=JSON.parse(e.postData.contents); } catch(err){ return ContentService.createTextOutput(JSON.stringify({success:false,msg:"Invalid JSON"})).setMimeType(ContentService.MimeType.JSON);}
  let ret=submitAbsensi(dt);
  return ContentService.createTextOutput(JSON.stringify(ret)).setMimeType(ContentService.MimeType.JSON);
}

function submitAbsensi(dt){
  let a=new absensi(dt);
  let ret={success:false,msg:''};
  if(!a.validUser()) ret.msg='Anda tidak terdaftar/barcode tidak cocok.';
  else{
    let cekJarak=a.validDistance();
    if(cekJarak!='confirm') ret.msg=cekJarak;
    else ret=a.saveAbsensi();
  }
  return ret;
}

function showIndex(){
  return templateIndex.evaluate().setSandboxMode(HtmlService.SandboxMode.IFRAME).addMetaTag('viewport','width=device-width, initial-scale=1').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getImage(fileId){
  let img=DriveApp.getFileById(fileId).getBlob().getBytes();
  return Utilities.base64Encode(img);
}

function testInput(){
  let dt={idPegawai:'20210001MT', password:'20210001', kegiatan:'test', absensi:'Masuk', workFrom:'WFH', position:[-6.089501,106.997263]};
  let a=new absensi(dt);
  if(!a.validUser()) Logger.log('Anda tidak terdaftar');
  else{
    let cekJarak=a.validDistance();
    if(cekJarak!='confirm') Logger.log(cekJarak);
    else Logger.log(a.saveAbsensi());
  }
}
