<!DOCTYPE html>
<html>
<head>
  <title>Absensi Kampus 2026 - Scan Kamera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap & icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- HTML5 QR code -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

  <style>
    body {
      min-height:100vh;
      margin:0;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family:'Segoe UI', sans-serif;
      background: linear-gradient(135deg,#0a3d62,#1e3799,#3c40c6);
    }
    .glass-card {
      backdrop-filter: blur(25px);
      background: rgba(255,255,255,0.12);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      padding: 30px 20px;
      max-width:380px;
      width:100%;
      text-align:center;
      color:white;
      position:relative;
    }
    .logo { width:70px; margin-bottom:8px;}
    h3 { font-size:1rem; margin-bottom:6px;}
    h4 { font-weight:400; margin-bottom:14px;}
    #scanner { width:100%; height:220px; border-radius:15px; overflow:hidden; position:relative; background: rgba(255,255,255,0.05); margin-bottom:10px;}
    #uploadLabel { display:flex; align-items:center; justify-content:center; gap:6px; margin-bottom:10px; cursor:pointer; font-size:.9rem;}
    #uploadLabel input { display:none;}
    input, select { background: rgba(255,255,255,0.15)!important; border:none!important; color:white!important; border-radius:10px;}
    input::placeholder{ color: rgba(255,255,255,0.7);}
    .btn-modern { border-radius:50px; font-weight:500; padding:8px; position:relative; overflow:hidden; transition: all .25s ease;}
    .btn-modern:hover { transform: translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.3);}
    .btn-modern:active { transform: scale(0.97);}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .6s linear;background-color:rgba(255,255,255,0.4);pointer-events:none;}
    @keyframes ripple{to{transform:scale(4);opacity:0;}}
    .scan-success{position:absolute;top:10px;right:10px;color:white;padding:8px 12px;border-radius:20px;font-weight:600;display:flex;align-items:center;gap:5px;opacity:0;transform:translateY(-20px);transition:opacity .4s ease,transform .4s ease,background-color .4s ease;z-index:10;}
    .scan-success.show{opacity:1;transform:translateY(0);}
    .login-toast{background:#0d6efd;}
    .masuk-toast{background:#28a745;}
    .pulang-toast{background:#fd7e14;}
  </style>
</head>
<body>
<div class="glass-card">
  <img src="https://raw.githubusercontent.com/zuyudh-pixel/absensi-V2/main/logo.png" class="logo">
  <h3>UIN KIAI AGENG MUHAMMAD BESARI PONOROGO</h3>
  <h4>Sistem Absensi Pegawai</h4>

  <div id="notif"></div>
  <div id="scanSuccess" class="scan-success"><i id="scanIcon" class="bi bi-check2-circle"></i> <span id="scanText">Scan Berhasil</span></div>

  <!-- LOGIN AREA -->
  <div id="loginArea">
    <div id="scanner"></div>
    <label id="uploadLabel" class="btn btn-outline-light btn-modern w-100">
      <i class="bi bi-upload"></i> Upload Gambar Barcode
      <input type="file" id="barcodeFile" accept="image/*">
    </label>
  </div>

  <!-- ABSEN AREA -->
  <div id="absenArea" style="display:none;">
    <h6 id="userInfo" class="mb-2"></h6>
    <select class="form-select mb-2" id="workfrom">
      <option value="WFO">WFO</option>
      <option value="WFH">WFH</option>
    </select>
    <input class="form-control mb-2" id="kegiatan" placeholder="Kegiatan">
    <div class="d-grid gap-2 mb-2">
      <button class="btn btn-success btn-modern" id="btnMasuk" onclick="absen('Masuk')"><i class="bi bi-door-open me-2"></i>Absen Masuk</button>
      <button class="btn btn-danger btn-modern" id="btnPulang" onclick="absen('Pulang')"><i class="bi bi-door-closed me-2"></i>Absen Pulang</button>
    </div>
    <button class="btn btn-outline-light w-100 btn-modern" onclick="resetForm()"><i class="bi bi-arrow-clockwise me-2"></i>Refresh</button>
  </div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzZkus_1zSCQCwIj78CF4eZKN0pIH9Ptfl2FNXEe34-W5yqF5-QMCHvYakEENSl-T67-g/exec";
let currentUser={};

function showNotif(msg,type="light"){ document.getElementById("notif").innerHTML=`<div class="alert alert-${type} mt-2">${msg}</div>`;}
function showScanSuccess(type="masuk"){
  const el=document.getElementById("scanSuccess");
  const txt=document.getElementById("scanText");
  const ic=document.getElementById("scanIcon");
  el.className="scan-success show";
  if(type==="login"){el.classList.add("login-toast"); txt.innerText="Login Berhasil"; ic.className="bi bi-person-check";}
  else if(type==="Masuk"){el.classList.add("masuk-toast"); txt.innerText="Absen Masuk Berhasil"; ic.className="bi bi-check2-circle";}
  else if(type==="Pulang"){el.classList.add("pulang-toast"); txt.innerText="Absen Pulang Berhasil"; ic.className="bi bi-box-arrow-right";}
  setTimeout(()=>el.classList.remove("show"),1200);
}
function updateButtons(){
  const key=new Date().toISOString().split('T')[0];
  const absenHariIni=JSON.parse(localStorage.getItem(key)||"{}");
  const userAbsen=absenHariIni[currentUser.id]||{};
  const btnMasuk=document.getElementById("btnMasuk");
  const btnPulang=document.getElementById("btnPulang");
  if(userAbsen.masuk){btnMasuk.style.display="none"; btnPulang.style.display=userAbsen.pulang?"none":"inline-block";}
  else{btnMasuk.style.display="inline-block"; btnPulang.style.display="none";}
}
function loginWithBarcode(id){
  if(!id) return;
  showNotif('Login sedang diproses...','info');
  fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"login",id:id})})
  .then(r=>r.json())
  .then(d=>{
    if(d.status==="success"){
      currentUser={id:id,nama:d.nama};
      document.getElementById("loginArea").style.display="none";
      document.getElementById("absenArea").style.display="block";
      document.getElementById("userInfo").innerText=d.nama+' - '+d.bagian;
      updateButtons(); showScanSuccess("login");
    }else showNotif("Login gagal","danger");
  }).catch(()=>showNotif("Server tidak merespon!","danger"));
}
function absen(tipe){
  showNotif("Mengirim data...","info");
  navigator.geolocation.getCurrentPosition(pos=>{
    const key=new Date().toISOString().split('T')[0];
    let absenHariIni=JSON.parse(localStorage.getItem(key)||"{}");
    absenHariIni[currentUser.id]=absenHariIni[currentUser.id]||{};
    if(tipe==="Masuk" && absenHariIni[currentUser.id].masuk){showNotif("Sudah absen masuk hari ini!","warning"); return;}
    fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({
      action:"absen",
      id:currentUser.id,
      nama:currentUser.nama,
      tipe:tipe,
      workfrom:document.getElementById("workfrom").value,
      kegiatan:document.getElementById("kegiatan").value,
      latitude:pos.coords.latitude,
      longitude:pos.coords.longitude
    })}).then(r=>r.json()).then(d=>{
      if(d.status==="success"){showNotif("Absensi berhasil!","success");
        absenHariIni[currentUser.id][tipe.toLowerCase()]=true;
        localStorage.setItem(key,JSON.stringify(absenHariIni));
        updateButtons(); showScanSuccess(tipe);}
      else if(d.status==="duplicate"){showNotif("Sudah absen hari ini!","warning");}
      else if(d.status==="out_of_radius"){showNotif("Di luar radius kampus!","danger");}
      else{showNotif("Terjadi kesalahan!","danger");}
    }).catch(()=>showNotif("Server tidak merespon!","danger"));
  },()=>showNotif("GPS tidak diizinkan!","danger"));
}
function resetForm(){currentUser={}; document.getElementById("loginArea").style.display="block"; document.getElementById("absenArea").style.display="none"; document.getElementById("notif").innerHTML=""; startScanner(); }

// Scanner kamera & upload
let html5QrCode;
function startScanner(){
  html5QrCode = new Html5Qrcode("scanner");
  Html5Qrcode.getCameras().then(cameras=>{
    if(cameras && cameras.length){
      const camId=cameras[0].id;
      html5QrCode.start(camId,{fps:10,qrbox:250},
        decodedText=>{
          loginWithBarcode(decodedText);
          html5QrCode.stop().then(()=>html5QrCode.start(camId,{fps:10,qrbox:250}));
        },
        err=>{}
      );
    }
  }).catch(err=>console.error(err));

  document.getElementById("barcodeFile").addEventListener("change",e=>{
    const file=e.target.files[0];
    if(file){
      Html5Qrcode.scanFile(file,true).then(decodedText=>{
        loginWithBarcode(decodedText);
      }).catch(err=>showNotif("Gagal membaca barcode","danger"));
    }
  });
}

window.onload=startScanner;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
