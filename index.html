<!DOCTYPE html>
<html>
<head>
  <title>Absensi Kampus 2026 - Futuristik</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <style>
    body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:linear-gradient(135deg,#0a3d62,#1e3799,#3c40c6);font-family:Segoe UI,sans-serif;}
    .glass-card{backdrop-filter:blur(25px);background:rgba(255,255,255,0.12);border-radius:20px;border:1px solid rgba(255,255,255,0.3);box-shadow:0 8px 32px rgba(0,0,0,0.2);padding:25px 20px;width:100%;max-width:380px;color:white;text-align:center;position:relative;}
    .logo{width:70px;margin-bottom:8px;}
    h3{margin-bottom:6px;font-size:1rem;}
    h4{margin-bottom:14px;font-weight:400;}
    input, select{background:rgba(255,255,255,0.15)!important;border:none!important;color:white!important;border-radius:10px;}
    input::placeholder{color:rgba(255,255,255,0.7);}
    .btn-modern{border-radius:50px;font-weight:500;padding:8px;position:relative;overflow:hidden;transition:all 0.25s ease;}
    .btn-modern:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}
    .btn-modern:active{transform:scale(0.97);}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple 0.6s linear;background-color:rgba(255,255,255,0.4);pointer-events:none;}
    @keyframes ripple{to{transform:scale(4);opacity:0;}}
    
    #scanner{width:100%;height:220px;border-radius:15px;overflow:hidden;position:relative;background:rgba(255,255,255,0.05);margin-bottom:10px;}
    #scanner::before{content:"";position:absolute;top:0;left:0;width:100%;height:3px;background:rgba(0,255,204,0.6);animation:scanLine 2s infinite;transition:background 0.3s,box-shadow 0.3s;}
    #scanner.scan-success-line::before{background:#28a745;box-shadow:0 0 12px #28a745,0 0 18px #28a74570;}
    @keyframes scanLine{0%{top:0;}50%{top:calc(100% - 3px);}100%{top:0;}}

    #uploadLabel{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:10px;cursor:pointer;font-size:0.9rem;}
    #uploadLabel input{display:none;}

    .scan-success{position:absolute;top:10px;right:10px;color:white;padding:8px 12px;border-radius:20px;font-weight:600;display:flex;align-items:center;gap:5px;opacity:0;transform:translateY(-20px);transition:opacity 0.4s,transform 0.4s,background-color 0.4s;z-index:10;}
    .scan-success.show{opacity:1;transform:translateY(0);}
    .login-toast{background:#0d6efd;}
    .masuk-toast{background:#28a745;}
    .pulang-toast{background:#fd7e14;}
  </style>
</head>
<body>
<div class="glass-card">
  <img src="https://raw.githubusercontent.com/zuyudh-pixel/absensi-V2/main/logo.png" class="logo" alt="Logo Kampus">
  <h3>UIN KIAI AGENG MUHAMMAD BESARI PONOROGO</h3>
  <h4>Sistem Absensi Pegawai</h4>

  <div id="notif"></div>

  <!-- Scan Success Toast -->
  <div id="scanSuccess" class="scan-success"><i id="scanIcon" class="bi bi-check2-circle"></i> <span id="scanText">Scan Berhasil</span></div>

  <!-- Scanner + Upload -->
  <div id="loginArea">
    <div id="scanner"></div>
    <label id="uploadLabel" class="btn btn-outline-light btn-modern w-100">
      <i class="bi bi-upload"></i> Upload Barcode
      <input type="file" id="barcodeFile" accept="image/*">
    </label>
  </div>

  <!-- Absen -->
  <div id="absenArea" style="display:none;">
    <h6 id="userInfo" class="mb-2"></h6>
    <select class="form-select mb-2" id="workfrom">
      <option value="WFO">WFO</option>
      <option value="WFH">WFH</option>
    </select>
    <input class="form-control mb-2" id="kegiatan" placeholder="Kegiatan">
    <div class="d-grid gap-2 mb-2">
      <button class="btn btn-success btn-modern" id="btnMasuk" onclick="absen('Masuk', event)">
        <i class="bi bi-door-open me-2"></i>Absen Masuk
      </button>
      <button class="btn btn-danger btn-modern" id="btnPulang" onclick="absen('Pulang', event)">
        <i class="bi bi-door-closed me-2"></i>Absen Pulang
      </button>
    </div>
    <button class="btn btn-outline-light w-100 btn-modern" onclick="resetForm(event)">
      <i class="bi bi-arrow-clockwise me-2"></i>Refresh
    </button>
  </div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzZkus_1zSCQCwIj78CF4eZKN0pIH9Ptfl2FNXEe34-W5yqF5-QMCHvYakEENSl-T67-g/exec";
let currentUser={}, html5QrCode=null;
const todayKey = ()=>new Date().toISOString().split('T')[0];

// Ripple
function createRipple(event){const b=event.currentTarget;const c=document.createElement("span");const d=Math.max(b.clientWidth,b.clientHeight);c.style.width=c.style.height=d+"px";c.style.left=event.clientX-b.getBoundingClientRect().left-d/2+"px";c.style.top=event.clientY-b.getBoundingClientRect().top-d/2+"px";c.classList.add("ripple");b.appendChild(c);c.addEventListener('animationend',()=>c.remove());}
document.querySelectorAll('.btn-modern').forEach(btn=>btn.addEventListener('click',createRipple));

function showNotif(msg,type="light"){document.getElementById("notif").innerHTML=`<div class="alert alert-${type} mt-2">${msg}</div>`;}
function showScanSuccess(type="masuk"){
  const el=document.getElementById("scanSuccess"),text=document.getElementById("scanText"),icon=document.getElementById("scanIcon"),scannerEl=document.getElementById("scanner");
  el.className="scan-success show";scannerEl.classList.add("scan-success-line");
  if(type==="login"){el.classList.add("login-toast");text.innerText="Login Berhasil";icon.className="bi bi-person-check";}
  else if(type==="Masuk"){el.classList.add("masuk-toast");text.innerText="Absen Masuk Berhasil";icon.className="bi bi-check2-circle";}
  else if(type==="Pulang"){el.classList.add("pulang-toast");text.innerText="Absen Pulang Berhasil";icon.className="bi bi-box-arrow-right";}
  setTimeout(()=>{el.classList.remove("show");scannerEl.classList.remove("scan-success-line");},1200);
}

// Update tombol
function updateButtons(){
  const key=todayKey(),absenHariIni=JSON.parse(localStorage.getItem(key)||"{}"),userAbsen=absenHariIni[currentUser.id]||{};
  const btnMasuk=document.getElementById("btnMasuk"),btnPulang=document.getElementById("btnPulang");
  if(userAbsen.masuk){btnMasuk.style.display="none";btnPulang.style.display=userAbsen.pulang?"none":"inline-block";}
  else{btnMasuk.style.display="inline-block";btnPulang.style.display="none";}
}

// Login
function loginWithBarcode(barcode){
  if(!barcode) return;
  showNotif('<i class="bi bi-hourglass-split me-2"></i>Login diproses...','info');
  fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({action:"login",id:barcode})})
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="success"){
      currentUser={id:barcode,nama:data.nama,bagian:data.bagian};
      document.getElementById("loginArea").style.display="none";
      document.getElementById("absenArea").style.display="block";
      document.getElementById("userInfo").innerText=data.nama+" - "+data.bagian;
      updateButtons();
      showScanSuccess("login");
    }else showNotif('<i class="bi bi-x-circle me-2"></i>Login gagal!','danger');
  }).catch(()=>showNotif('<i class="bi bi-x-octagon me-2"></i>Server tidak merespon!','danger'));
}

// Absen
function absen(tipe){
  showNotif('<i class="bi bi-hourglass-split me-2"></i>Mengirim data...','info');
  navigator.geolocation.getCurrentPosition(pos=>{
    const key=todayKey(),absenHariIni=JSON.parse(localStorage.getItem(key)||"{}");
    absenHariIni[currentUser.id]=absenHariIni[currentUser.id]||{};
    if(tipe==="Masuk" && absenHariIni[currentUser.id].masuk){showNotif('<i class="bi bi-exclamation-triangle me-2"></i>Sudah absen masuk!','warning');return;}
    fetch(WEB_APP_URL,{method:"POST",body:new URLSearchParams({
      action:"absen",id:currentUser.id,nama:currentUser.nama,tipe:tipe,
      workfrom:document.getElementById("workfrom").value,kegiatan:document.getElementById("kegiatan").value,
      latitude:pos.coords.latitude,longitude:pos.coords.longitude
    })}).then(res=>res.json()).then(data=>{
      if(data.status==="success"){
        showNotif('<i class="bi bi-check-circle me-2"></i>Absensi berhasil!','success');
        absenHariIni[currentUser.id][tipe.toLowerCase()]=true;
        localStorage.setItem(key,JSON.stringify(absenHariIni));
        updateButtons();
        showScanSuccess(tipe);
      }else if(data.status==="duplicate") showNotif('<i class="bi bi-exclamation-triangle me-2"></i>Sudah absen!','warning');
      else if(data.status==="out_of_radius") showNotif('<i class="bi bi-geo-alt me-2"></i>Di luar radius kampus!','danger');
      else showNotif('<i class="bi bi-x-circle me-2"></i>Terjadi kesalahan!','danger');
    }).catch(()=>showNotif('<i class="bi bi-x-octagon me-2"></i>Server tidak merespon!','danger'));
  },()=>showNotif('<i class="bi bi-geo-alt-slash me-2"></i>GPS tidak diizinkan!','danger'));
}

// Reset
function resetForm(){currentUser={};document.getElementById("loginArea").style.display="block";document.getElementById("absenArea").style.display="none";document.getElementById("notif").innerHTML="";}

// Init scanner
function initScanner(){
  html5QrCode=new Html5Qrcode("scanner");
  Html5Qrcode.getCameras().then(cameras=>{
    if(cameras && cameras.length){
      html5QrCode.start(
        {facingMode:"environment"},{fps:10,qrbox:250},
        decodedText=>loginWithBarcode(decodedText)
      ).catch(err=>console.error(err));
    }
  }).catch(err=>console.error(err));

  document.getElementById("barcodeFile").addEventListener("change",function(e){
    const file=e.target.files[0];
    if(file){
      Html5Qrcode.scanFile(file,true).then(decodedText=>loginWithBarcode(decodedText))
      .catch(err=>alert("Gagal membaca barcode"));
    }
  });
}

window.onload=initScanner;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
