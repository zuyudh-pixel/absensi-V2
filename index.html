<!DOCTYPE html>
<html>
<head>
  <title>Absensi Kampus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow p-4">

    <h3 class="text-center mb-4">Sistem Absensi Pegawai</h3>

    <div id="loginArea">
      <input class="form-control mb-2" id="id" placeholder="ID Pegawai">
      <input type="password" class="form-control mb-3" id="password" placeholder="Password">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>
    </div>

    <div id="absenArea" style="display:none;">
      <h5 id="userInfo" class="text-center mb-3"></h5>

      <select class="form-select mb-2" id="workfrom">
        <option value="WFO">WFO</option>
        <option value="WFH">WFH</option>
      </select>

      <input class="form-control mb-3" id="kegiatan" placeholder="Kegiatan">

      <div class="d-grid gap-2">
        <button class="btn btn-success" onclick="absen('Masuk')">Absen Masuk</button>
        <button class="btn btn-danger" onclick="absen('Pulang')">Absen Pulang</button>
      </div>
    </div>

  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxYhb5goSdgzgxtBOtaidXZli2tMVvKXFaGyR3o19JAIaOlJ4lZbaRyWfr50pcQ1YoVTQ/exec";
let currentUser = {};

function login() {
  fetch(WEB_APP_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "login",
      id: id.value,
      password: password.value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      currentUser = { id: id.value, nama: data.nama };
      loginArea.style.display = "none";
      absenArea.style.display = "block";
      userInfo.innerText = data.nama + " - " + data.bagian;
    } else {
      alert("Login gagal!");
    }
  });
}

function absen(tipe) {
  navigator.geolocation.getCurrentPosition(function(pos) {

    fetch(WEB_APP_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "absen",
        id: currentUser.id,
        nama: currentUser.nama,
        tipe: tipe,
        workfrom: workfrom.value,
        kegiatan: kegiatan.value,
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
      })
    })
    .then(res => res.json())
    .then(data => {

      if (data.status === "success")
        alert("Absensi berhasil");

      else if (data.status === "duplicate")
        alert("Anda sudah absen hari ini!");

      else if (data.status === "out_of_radius")
        alert("Anda di luar radius kampus!");

    });

  });
}
</script>

</body>
</html>
