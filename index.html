<!DOCTYPE html>
<html>
<head>
  <title>Absensi Kampus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
body {
  min-height: 100vh;
  background: linear-gradient(135deg, #a2d2ff, #74c0fc);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Segoe UI', sans-serif;
}

    /* Glass card tetap blur */
.glass-card {
  backdrop-filter: blur(20px);
  background: rgba(255, 255, 255, 0.15);  /* transparan */
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  padding: 40px;
  width: 100%;
  max-width: 420px;
  color: white;
}
    input, select {
      background: rgba(255,255,255,0.2) !important;
      border: none !important;
      color: white !important;
    }

    input::placeholder {
      color: rgba(255,255,255,0.8);
    }

    .btn-modern {
      border-radius: 50px;
      font-weight: 500;
      padding: 10px;
    }

/* Logo tampil natural, tidak ada lingkaran/kotak */
.logo {
  width: 80px;          /* bisa disesuaikan */
  height: auto;         /* otomatis mengikuti proporsi asli */
  object-fit: contain;   /* pastikan proporsional */
  margin-bottom: 15px;
  transition: transform 0.3s ease;
}

.logo:hover {
  transform: scale(1.08);
}

.btn-modern {
  border-radius: 50px;
  font-weight: 500;
  padding: 10px;
  transition: all 0.25s ease;
}

.btn-modern:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.btn-modern:active {
  transform: scale(0.97);
}

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>

<div class="glass-card text-center">

  <img src="https://raw.githubusercontent.com/zuyudh-pixel/absensi-V2/main/logo.png"
     class="logo"
     alt="Logo Kampus">

  <h4 class="mb-4">Sistem Absensi Pegawai</h4>

  <div id="notif"></div>

  <!-- LOGIN -->
  <div id="loginArea">
    <input class="form-control mb-3" id="idInput" placeholder="ID Pegawai">
    <input type="password" class="form-control mb-3" id="passwordInput" placeholder="Password">
    <button class="btn btn-light w-100 btn-modern" onclick="login()">
  <i class="bi bi-box-arrow-in-right me-2"></i>Login
</button>
  </div>

  <!-- ABSEN -->
  <div id="absenArea" style="display:none;">
    <h6 id="userInfo" class="mb-3"></h6>

    <select class="form-select mb-3" id="workfrom">
      <option value="WFO">WFO</option>
      <option value="WFH">WFH</option>
    </select>

    <input class="form-control mb-3" id="kegiatan" placeholder="Kegiatan">

    <div class="d-grid gap-2 mb-3">
      <button class="btn btn-danger btn-modern" onclick="absen('Pulang')">
  <i class="bi bi-door-closed me-2"></i>Absen Pulang
</button>
    </div>

    <!-- TOMBOL REFRESH -->
    <button class="btn btn-outline-light w-100 btn-modern" onclick="resetForm()">
  <i class="bi bi-arrow-clockwise me-2"></i>Refresh
</button>
  </div>

</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzZkus_1zSCQCwIj78CF4eZKN0pIH9Ptfl2FNXEe34-W5yqF5-QMCHvYakEENSl-T67-g/exec";
let currentUser = {};

function showNotif(message, type="light") {
  document.getElementById("notif").innerHTML =
    `<div class="alert alert-${type} mt-2">${message}</div>`;
}

function login() {

  const id = document.getElementById("idInput").value;
  const password = document.getElementById("passwordInput").value;

  if(!id || !password){
    showNotif("ID dan Password wajib diisi!", "warning");
    return;
  }

  fetch(WEB_APP_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "login",
      id: id,
      password: password
    })
  })
  .then(res => res.json())
  .then(data => {

    if (data.status === "success") {

      currentUser = {
        id: id,
        nama: data.nama
      };

      document.getElementById("loginArea").style.display = "none";
      document.getElementById("absenArea").style.display = "block";
      document.getElementById("userInfo").innerText =
        data.nama + " - " + data.bagian;

      showNotif("Login berhasil!", "success");

    } else {
      showNotif("Login gagal!", "danger");
    }

  })
  .catch(err => {
    showNotif("Server tidak merespon!", "danger");
  });
}

function absen(tipe) {

  // ✅ Tampilkan notifikasi "Mengirim data..." saat mulai absen
  showNotif('<i class="bi bi-hourglass-split me-2"></i>Mengirim data...', 'info');

  // Ambil posisi GPS
  navigator.geolocation.getCurrentPosition(

    function(pos) {

      fetch(WEB_APP_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "absen",
          id: currentUser.id,
          nama: currentUser.nama,
          tipe: tipe,
          workfrom: document.getElementById("workfrom").value,
          kegiatan: document.getElementById("kegiatan").value,
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude
        })
      })
      .then(res => res.json())
      .then(data => {

        // ✅ Hapus notif loading, ganti dengan status final
        if (data.status === "success") {
          showNotif('<i class="bi bi-check-circle me-2"></i>Absensi berhasil!', 'success');
        }

        else if (data.status === "duplicate") {
          showNotif('<i class="bi bi-exclamation-triangle me-2"></i>Sudah absen hari ini!', 'warning');
        }

        else if (data.status === "out_of_radius") {
          showNotif('<i class="bi bi-geo-alt me-2"></i>Di luar radius kampus!', 'danger');
        }

        else {
          showNotif('<i class="bi bi-x-circle me-2"></i>Terjadi kesalahan!', 'danger');
        }

      })
      .catch(() => {
        showNotif('<i class="bi bi-x-octagon me-2"></i>Server tidak merespon!', 'danger');
      });

    },

    function() {
      showNotif('<i class="bi bi-geo-alt-slash me-2"></i>GPS tidak diizinkan!', 'danger');
    }

  );
}

function resetForm() {

  currentUser = {};

  document.getElementById("idInput").value = "";
  document.getElementById("passwordInput").value = "";
  document.getElementById("kegiatan").value = "";

  document.getElementById("loginArea").style.display = "block";
  document.getElementById("absenArea").style.display = "none";
  document.getElementById("notif").innerHTML = "";

}
</script>

</body>
</html>
