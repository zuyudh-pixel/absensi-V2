<!DOCTYPE html>
<html>
<head>
  <title>Absensi Kampus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow p-4">
<div class="card shadow p-4 text-center">

  <!-- LOGO -->
  <img src="https://raw.githubusercontent.com/zuyudh-pixel/absensi-V2/main/logo.png"
       alt="Logo Kampus"
       style="max-width:120px;"
       class="mb-3 mx-auto d-block">
  <h3 class="mb-4">UIN KIAI AGENG ABUYAMIN PONOROGO</h3>
   <h3 class="text-center mb-4">Absensi Dosen Pengampu</h3>

    <!-- NOTIFIKASI -->
    <div id="notif"></div>

    <!-- LOGIN -->
    <div id="loginArea">
      <input class="form-control mb-2" id="idInput" placeholder="ID Pegawai">
      <input type="password" class="form-control mb-3" id="passwordInput" placeholder="Password">
      <button class="btn btn-primary w-100" onclick="login()">Login</button>
    </div>

    <!-- ABSEN -->
    <div id="absenArea" style="display:none;">
      <h5 id="userInfo" class="text-center mb-3"></h5>

      <select class="form-select mb-2" id="workfrom">
        <option value="WFO">WFO</option>
        <option value="WFH">WFH</option>
      </select>

      <input class="form-control mb-3" id="kegiatan" placeholder="Kegiatan">

      <div class="d-grid gap-2">
        <button class="btn btn-success" onclick="absen('Masuk')">Absen Masuk</button>
        <button class="btn btn-danger" onclick="absen('Pulang')">Absen Pulang</button>
      </div>
    </div>

  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzZkus_1zSCQCwIj78CF4eZKN0pIH9Ptfl2FNXEe34-W5yqF5-QMCHvYakEENSl-T67-g/exec";
let currentUser = {};

function showNotif(message, type="info") {
  document.getElementById("notif").innerHTML =
    `<div class="alert alert-${type} alert-dismissible fade show">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
     </div>`;
}

function login() {

  const id = document.getElementById("idInput").value;
  const password = document.getElementById("passwordInput").value;

  if(!id || !password){
    showNotif("ID dan Password wajib diisi!", "warning");
    return;
  }

  fetch(WEB_APP_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "login",
      id: id,
      password: password
    })
  })
  .then(res => res.json())
  .then(data => {

    if (data.status === "success") {

      currentUser = {
        id: id,
        nama: data.nama
      };

      document.getElementById("loginArea").style.display = "none";
      document.getElementById("absenArea").style.display = "block";
      document.getElementById("userInfo").innerText =
        data.nama + " - " + data.bagian;

      showNotif("Login berhasil!", "success");

    } else {
      showNotif("Login gagal! ID / Password salah.", "danger");
    }

  })
  .catch(err => {
    showNotif("Gagal terhubung ke server!", "danger");
    console.error(err);
  });
}

function absen(tipe) {

  navigator.geolocation.getCurrentPosition(

    function(pos) {

      fetch(WEB_APP_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "absen",
          id: currentUser.id,
          nama: currentUser.nama,
          tipe: tipe,
          workfrom: document.getElementById("workfrom").value,
          kegiatan: document.getElementById("kegiatan").value,
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude
        })
      })
      .then(res => res.json())
      .then(data => {

        if (data.status === "success") {
          showNotif("Absensi berhasil!", "success");
        }

        else if (data.status === "duplicate") {
          showNotif("Anda sudah absen hari ini!", "warning");
        }

        else if (data.status === "out_of_radius") {
          showNotif("Anda berada di luar radius kampus!", "danger");
        }

        else {
          showNotif("Terjadi kesalahan!", "danger");
        }

      })
      .catch(err => {
        showNotif("Server tidak merespon!", "danger");
        console.error(err);
      });

    },

    function(error) {
      showNotif("GPS tidak diizinkan atau gagal dibaca!", "danger");
    }

  );
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
